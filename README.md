# Серверное приложение JWT-авторизации на Node JS

## О проекте

Приложение является имлпементацией JWT-авторизации. Для работы с access и refresh токенами используется симметричное шифрование. Срок жизни access токена составляет 15 минут, refresh токена - 30 дней. Когда access токен истекает, то валидируется refresh токен, а затем генерируется новый access токен (то есть обновления access токена происходит без обращения к базе данных для ускорения этого процесса)

---

## Используемый стек технологий

### Основные зависимости проекта

Серверное приложение написано для среды выполнения **Node JS** с использованием фреймворка **Express.js** на языке **TypeScript**. Для работой с базой данных используется **СУБД PostgreSQL**. Для реализации jwt-авторизации используется библиотека **jsonwebtoken**, которая является реализацией стандарта **[RFC 7519](https://datatracker.ietf.org/doc/html/rfc7519)**. Все используемые в проекте зависимости:

- **[@dotenvx/dotenvx](https://dotenvx.com/): v1.14.2** — Усовершенствованный модуль для загрузки переменных среды из файлов `.env`, предлагающий дополнительные возможности по сравнению со стандартным `dotenv`.
- **[bcryptjs](https://github.com/dcodeIO/bcrypt.js): v2.4.3** — Библиотека для хэширования паролей с использованием bcrypt на JavaScript.
- **[cookie-parser](https://github.com/expressjs/cookie-parser): v1.4.6** — Middleware для разбора файлов cookie в Express.js.
- **[cors](https://github.com/expressjs/cors): v2.8.5** — Middleware разрешения Cross-Origin Resource Sharing (CORS) Policy.
- **[express](https://expressjs.com/): v4.20.0** — Веб-фреймворк для Node.js.
- **[express-validator](https://express-validator.github.io/docs): v7.2.0** — Набор express.js middlewares, который обеспечивает проверку данных.
- **[jsonwebtoken](https://github.com/auth0/node-jsonwebtoken): v9.0.2** — Библиотека для генерирования, верификации и декодирования JSON Web Tokens (JWT).
- **[nodemailer](https://nodemailer.com/): v6.9.14** — Модуль для NodeJS приложений для отправки email писем.
- **[pg](https://node-postgres.com/): v8.12.0** — Модуль для взаимодействия с базой данных PostgreSQL.
- **[ua-parser-js](https://uaparser.dev/): v1.0.38** — Библиотека для определения информации о браузере, движке, операционной системе, процессоре и устройстве из строки User-Agent.
- **[uuid](https://www.npmjs.com/package/uuid): v10.0.0** — Библиотека для генерации уникальных идентификаторов (UUID), совместимая с RFC 4122.

### Зависимости для разработки проекта

В проекте используются следующие зависимости для разработки (большая часть из них - это типы для используемых библиотек):

- **[@eslint/js](https://www.npmjs.com/package/@eslint/js): v9.8.0** — Набор встроенных правил ESLint для JavaScript.
- **[@types/bcryptjs](https://www.npmjs.com/package/@types/bcryptjs): v2.4.6** — Пакет типов Typescript для библиотеки `bcryptjs`.
- **[@types/cookie-parser](https://www.npmjs.com/package/@types/cookie-parser): v1.4.7** — Пакет типов Typescript для библиотеки `cookie-parser`.
- **[@types/cors](https://www.npmjs.com/package/@types/cors): v2.8.17** — Пакет типов Typescript для библиотеки `cors`.
- **[@types/eslint](https://www.npmjs.com/package/@types/eslint): v9.6.0** — Пакет типов Typescript для ESLint.
- **[@types/eslint\_\_js](https://www.npmjs.com/package/@types/eslint__js): v8.42.3** — Пакет типов Typescript для ESLint JS пакета.
- **[@types/eslint-config-prettier](https://www.npmjs.com/package/@types/eslint-config-prettier): v6.11.3** — Пакет типов Typescript для `eslint-config-prettier`.
- **[@types/express](https://www.npmjs.com/package/@types/express): v4.17.21** — Пакет типов Typescript для Express.js.
- **[@types/jsonwebtoken](https://www.npmjs.com/package/@types/jsonwebtoken): v9.0.6** — Пакет типов Typescript для `jsonwebtoken`.
- **[@types/nodemailer](https://www.npmjs.com/package/@types/nodemailer): v6.4.15** — Пакет типов Typescript для Nodemailer.
- **[@types/pg](https://www.npmjs.com/package/@types/pg): v8.11.6** — Пакет типов Typescript для `pg`.
- **[@types/ua-parser-js](https://www.npmjs.com/package/@types/ua-parser-js): v0.7.39** — Пакет типов Typescript для `ua-parser-js`.
- **[@types/uuid](https://www.npmjs.com/package/@types/uuid): v10.0.0** — Пакет типов Typescript для `uuid`.
- **[@typescript-eslint/parser](https://typescript-eslint.io/packages/parser/): v8.7.0** — TypeScript парсер для EsLint, используемый для разбора кода TypeScript на узлы, совместимые с ESLint.
- **[cross-env](https://github.com/kentcdodds/cross-env): v7.0.3** — Пакет для настройки переменных среды на разных платформах.
- **[esbuild](https://esbuild.github.io/): v0.23.0** — Сборщик проекта.
- **[esbuild-plugin-clean](https://www.npmjs.com/package/esbuild-plugin-clean): v1.0.1** — Плагин для очистки output директории после каждой сборки.
- **[eslint](https://eslint.org/): v9.8.0** — Статический анализатор кода для нахождения и исправления ошибок.
- **[eslint-config-prettier](https://github.com/prettier/eslint-config-prettier): v9.1.0** — Конфиг для отключения EsLint правил, которые могут конфликтовать с Prettier.
- **[globals](https://github.com/sindresorhus/globals): v15.8.0** — Библиотека глобально доступных переменных в JavaScript.
- **[husky](https://typicode.github.io/husky/): v9.1.4** — Инструмент для создания Git-hook'ов, позволяющий выполнять действия перед или после git-действий.
- **[lint-staged](https://github.com/lint-staged/lint-staged): v15.2.8** — Инструмент для выполнения действий только для Git-staged файлов.
- **[nodemon](https://nodemon.io/): v3.1.4** — Инструмент для автоматического перезапуска NodeJS сервера, когда изменения файла обнаружены.
- **[prettier](https://prettier.io/): v3.3.3** — Форматтер кода для различных языков.
- **[prettier-plugin-sql](https://www.npmjs.com/package/prettier-plugin-sql): v0.18.1** — Prettier-плагин для добавления форматирования в sql-файлах.
- **[tsx](https://tsx.is/): v4.16.5** — Среда выполнения для Typescript-файлов.
- **[typescript](https://www.typescriptlang.org/): v5.5.4** — Типизированный язык программирования, основанный на JavaScript.
- **[typescript-eslint](https://typescript-eslint.io/): v8.0.0** — Инструментарий, который позволяет ESLint и Prettier поддерживать TypeScript.

---

## Конфигурация проекта

Сборка проекта реализована через esbuild. Файлы конфигурации сборки находятся по пути `config\build` относительно корня проекта

В файле `esbuild-config.mts` определены основные опции сборки, например, платформа приложения, когда необходимо минифицировать файлы сборки, когда нужно подключать файлы sourcemap, в какой язык транспилируется файл сборки и так далее. Все общие опции с краткими комментариями можно посмотреть там (при наведении на опции среда разработки отобразит также ссылку на нужный раздел документации esbuild).

Файл `esbuild-dev.mts` определяет запуск сборки в режиме watch для разработки. Для процесса разработки определяются свои env-переменные SERVER_URL и CLIENT_URL. Также дополнительно подключается плагин devMessagingPlugin для информирования о текущем состоянии сборки.

Файл `esbuild-prod.mts` определяет запуск production-сборки. Здесь определяются другие env-переменные SERVER_URL и CLIENT_URL, которые соответствуют адресам, по которым размещены серверная и фронтенд части приложения по авторизации. Также дополнительно задается переменная IS_PROD, которая используется в некоторых хелперах проекта.

---

## Архитектура проекта

### Структура базы данных

Проект использует базу данных PostgreSQL под названием `auth_server`, которая включает три основные таблицы: `users`, `pending_users` и `tokens`. Ниже представлено описание каждой таблицы и её структуры:

#### **1. Таблица `users`**

Эта таблица хранит данные зарегистрированных и подтвержденных пользователей.

- **Столбцы**:
  - `id_user`: Целочисленный, первичный ключ. Уникально идентифицирует пользователя.
  - `password`: `VARCHAR(255)`, не может быть пустым. Хранит зашифрованный пароль пользователя.
  - `email`: `VARCHAR(255)`, уникальный, не может быть пустым. Хранит email пользователя.

#### **2. Таблица `pending_users`**

Эта таблица содержит временные данные для пользователей, которые находятся в процессе регистрации, но ещё не завершили активацию по электронной почте.

- **Столбцы**:

  - `id_user`: Последовательный целочисленный, первичный ключ. Автоматически инкрементируемый ID для каждого временного пользователя. Далее этот id_user будет назначен для id_user из таблицы users
  - `email`: `VARCHAR(255)`, уникальный, не может быть пустым. Хранит email временного пользователя.
  - `password`: `VARCHAR(255)`, не может быть пустым. Хранит зашифрованный пароль временного пользователя.
  - `activation_token`: `TEXT`, не может быть пустым. Токен, используемый для подтверждения email и завершения регистрации.
  - `resend_expiration`: `TIMESTAMP`, не может быть пустым, по умолчанию. Метка времени, указывающая, до какого момента можно повторно запросить отправки ссылки активации (по умолчанию через 1 день после создания).

- **Индексы**:
  - `idx_email`: Индекс по столбцу `email` для оптимизации запросов, связанных с поиском пользователей по email.

#### **3. Таблица `tokens`**

Эта таблица хранит аутентификационные токены пользователей, которые используются для поддержки сессий. Один пользователь может иметь несколько сессий, что соответствует, например, использованию приложения с разных устройств

- **Столбцы**:
  - `id_token`: Последовательный целочисленный, первичный ключ. Автоматически инкрементируемый ID для каждого токена.
  - `id_user`: Целочисленный, внешний ключ. Ссылается на `id_user` в таблице `users`. Связывает токен с определённым пользователем.
  - `token`: `TEXT`, уникальный, не может быть пустым. Хранит сессионный токен пользователя.
  - `caption`: `TEXT`, не может быть пустым. Содержит метаданные, которые используются при обновлении refresh токена.
  - `user_agent`: `TEXT`, не может быть пустым. Хранит информацию о пользовательском агенте (например, данные браузера), который использовался при аутентификации.
  - `created_at`: `TIMESTAMP`, не может быть пустым, по умолчанию. Метка времени, указывающая, когда токен был создан (по умолчанию текущее время).
  - `updated_at`: `TIMESTAMP`, не может быть пустым, по умолчанию. Метка времени, указывающая, когда токен был последним обновлен (по умолчанию текущее время).

Эта структура базы данных поддерживает процесс регистрации пользователей, активацию временных пользователей и управление сессиями с помощью токенов. Таблица `pending_users` позволяет обеспечить безопасный процесс, при котором пользователи должны подтвердить свою электронную почту перед полной регистрацией, а таблица `tokens` гарантирует, что пользовательские сессии отслеживаются с учётом соответствующих метаданных.

### Структура проекта

```
AUTH-APP/
│
├── .husky/                    # Git hooks, управляемые с помощью Husky
├── .vercel/                   # Конфигурация для деплоя на Vercel (не включается в Git)
├── @types/                    # Файлы деклараций типов TypeScript
├── build/                     # Собранные файлы для production-сборки (не включается в Git)
│
├── config/
│   └── build/                 # Конфигурации для сборки
│       ├── plugins/           # Плагины для сборки
│       ├── esbuild-config.mts # Основная конфигурация для esbuild
│       ├── esbuild-dev.mts    # Конфигурация для разработки
│       └── esbuild-prod.mts   # Конфигурация для production-сборки
│
├── src/                       # Исходный код приложения
│   ├── api/                   # Классы, предоставляющие методы по выполнению запросов для соответствующих таблиц базы данных
│   ├── db/                    # Описание скриптов для создания базы данных и подключение к ней
│   ├── errors/                # Кастомные клиенсткие и серверные ошибки
│   ├── jwt/                   # Логика работы с JWT
│   ├── controllers/       # Контроллеры, которые выполняют промежуточные действия для дальнейшего выполненния основной бизнес-логики
│   └── models/            # Основная бизнес-логика JWT
│   ├── middlewares/           # Middleware для Express.js
│   ├── routes/                # Определение маршрутов
│   ├── types/                 # Определение типов данных
│   ├── utils/                 # Вспомогательные утилиты
│   └── index.ts               # Точка входа приложения
│
├── temp/                      # Папка, которая появляется при режиме разработки (не включается в Git)
│
├── .env                       # Переменные окружения (не включается в Git)
├── .gitignore                 # Файл для исключения файлов из Git
├── .prettierignore            # Исключения для Prettier
├── .prettierrc                # Конфигурация Prettier
├── comments.txt               # Внутренние заметки (не включаются в Git)
├── eslint.config.mjs          # Конфигурация ESLint
├── package-lock.json          # Фиксация версий зависимостей
├── package.json               # Основной файл проекта
├── README.md                  # Описание проекта
├── tsconfig.json              # Конфигурация TypeScript
└── vercel.json                # Конфигурация для Vercel
```

---

## Поддержание качества кода

Для поддержания качества кода в проекте используется eslint и prettier. Их конфигурацию можно посмотреть в файлах `eslint.config.mjs` и `.prettierrc`. В проекте используется 9 версия eslint. Подробную информацию по настройке 9 версии eslint с flat config можно прочитать в [документации](https://eslint.org/docs/latest/use/configure/).

---

## Скрипты проекта

- `npm run compile` - Запуск сборки проекта через esbuild для разработки в режиме watch (формируется отдельная папка temp с файлами сборки на JS и .map файлами)
- `npm run start` - Запуск nodemon для автоматического перезапуска сервера в режиме разработки
- `npm run build` - Запуск production-сборки проекта через esbuild (формируется отдельная папка build с минимизированной сборкой проекта на JS)
- `npm run build:vercel` - Запуск production-сборки проекта через esbuild и публикация на vercel
- `npm run lint` - Запуск статического анализатора eslint для всей кодовой базы
- `npm run lint:fix` - Запуск автоисправления ошибок, которые eslint сам может поправить
- `npm run prettier` - Запуск форматирования кода через prettier

---

## Будущие изменения в проекте

В ближайшее время хочу декомпозировать код таким образом, чтобы разгрузить кодовую базу в файлах model'ей. Сейчас они получились довольно перегруженными.

Затем необходимо покрыть проект тестами

Также хочется рассмотреть использования in-memory базы данных, в частности, для таблицы pending_users, в которой хранятся пользователи, прошедшие первый этап регистрации, но еще не подтвердившие свой аккаунт через ссылку активации, которая отправляется на указанную почту. Мне кажется, что PostgreSQL не очень хорошо для этого подходит (еще учитывая тот факт, что я не добавлял CRON-операции для автоочистики данной таблицы). В качестве такой in-memory базы данных хочу взять KeyDB.

Для обеспечения большего контроля над процессом работы приложения необходимо в будущем проработать black list для отметки подозрительных refresh токенов
